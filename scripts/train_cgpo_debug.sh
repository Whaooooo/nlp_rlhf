#!/bin/bash

python -m realhf.apps.quickstart cgpo \
    mode=local \
    task_number=2 \
    experiment_name=mistral-mix-2task-cgpo \
    trial_name=debug1 \
    exp_ctrl.total_train_epochs=1 \
    exp_ctrl.save_freq_steps=150 \
    allocation_mode=heuristic \
    ref.type._class=mistral \
    ref.type.size=7 \
    ref.backend=deepspeed \
    ref.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-mrsft/debug/default/epoch1epochstep6982globalstep6982 \
    ref.offload=True \
    ref_inf.n_mbs=8 \
    task0.actor.type._class=mistral \
    task0.actor.type.size=8 \
    task0.actor.zero_stage=0 \
    task0.actor.backend=megatron \
    task0.actor.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-mrsft/debug/default/epoch1epochstep6982globalstep6982 \
    task0.actor.gradient_checkpointing=True \
    task0.actor.optimizer.warmup_steps_proportion=0.1 \
    task0.actor.optimizer.weight_decay=0.0 \
    task0.actor.optimizer.lr=0.000001 \
    task0.critic.type._class=mistral \
    task0.critic.type.size=8 \
    task0.critic.type.is_critic=True \
    task0.critic.backend=megatron \
    task0.critic.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-tuluPref-rw/test/default/epoch2epochstep5globalstep111 \
    task0.critic.gradient_checkpointing=True \
    task0.critic.optimizer.warmup_steps_proportion=0.1 \
    task0.critic.optimizer.weight_decay=0.0 \
    task0.critic.optimizer.lr=0.000001 \
    task0.reward.type._class=mistral \
    task0.reward.type.size=7 \
    task0.reward.type.is_critic=True \
    task0.reward.backend=deepspeed \
    task0.reward.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-tuluPref-rw/test/default/epoch2epochstep5globalstep111 \
    task0.reward.offload=True \
    task0.dataset.path=/mnt/zzo/asset/dataset/rw/chat/allenai___tulu-2.5-preference-data/allenai___tulu-2.5-preference-data_train.json \
    task0.dataset.max_prompt_len=1024 \
    task0.dataset.train_bs_n_seqs=64 \
    task0.dataset.max_dataset_len=80000 \
    task0.cgpo.gen.max_new_tokens=512 \
    task0.cgpo.gen.min_new_tokens=1 \
    task0.cgpo.gen.top_p=1.0 \
    task0.cgpo.gen.temperature=1.0 \
    task0.cgpo.gen.top_k=1 \
    task0.cgpo.gen.force_no_logits_mask=True \
    task0.cgpo.cgpo_n_minibatches=1 \
    task0.actor_train.n_mbs=4 \
    task0.actor_gen.n_mbs=1 \
    task0.critic_train.n_mbs=1 \
    task0.critic_inf.n_mbs=1 \
    task0.rew_inf.n_mbs=1 \
    task0.cgpo.kl_ctl=0.05 \
    task0.cgpo.reward_output_scaling=2 \
    task0.cgpo.reward_output_bias=0.0 \
    task0.cgpo.gae_lambda=1.0 task0.cgpo.no_eos_penalty=-10. \
    task0.cgpo.adv_norm=True task0.cgpo.value_norm=True \
    task1.actor.type._class=mistral \
    task1.actor.type.size=8 \
    task1.actor.zero_stage=0 \
    task1.actor.backend=megatron \
    task1.actor.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-mrsft/debug/default/epoch1epochstep6982globalstep6982 \
    task1.actor.gradient_checkpointing=True \
    task1.actor.optimizer.warmup_steps_proportion=0.1 \
    task1.actor.optimizer.weight_decay=0.0 \
    task1.actor.optimizer.lr=0.000001 \
    task1.critic.type._class=mistral \
    task1.critic.type.size=8 \
    task1.critic.type.is_critic=True \
    task1.critic.backend=megatron \
    task1.critic.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-saferlhf-rw/debug/default/epoch2epochstep1globalstep144 \
    task1.critic.gradient_checkpointing=True \
    task1.critic.optimizer.warmup_steps_proportion=0.1 \
    task1.critic.optimizer.weight_decay=0.0 \
    task1.critic.optimizer.lr=0.000001 \
    task1.reward.type._class=mistral \
    task1.reward.type.size=7 \
    task1.reward.type.is_critic=True \
    task1.reward.backend=deepspeed \
    task1.reward.path=/mnt/zzo/.cache/realhf/checkpoints/root/mistral-mix-saferlhf-rw/debug/default/epoch2epochstep1globalstep144 \
    task1.reward.offload=True \
    task1.dataset.path=/mnt/zzo/asset/dataset/rw/safe/PKU-Alignment___pku-safe_rlhf/PKU-Alignment___pku-safe_rlhf_default_train.json \
    task1.dataset.max_prompt_len=1024 \
    task1.dataset.train_bs_n_seqs=64 \
    task1.cgpo.gen.max_new_tokens=512 \
    task1.cgpo.gen.min_new_tokens=1 \
    task1.cgpo.gen.top_p=1.0 \
    task1.cgpo.gen.temperature=1.0 \
    task1.cgpo.gen.top_k=1 \
    task1.cgpo.gen.force_no_logits_mask=True \
    task1.cgpo.cgpo_n_minibatches=1 \
    task1.actor_train.n_mbs=4 \
    task1.actor_gen.n_mbs=1 \
    task1.critic_train.n_mbs=1 \
    task1.critic_inf.n_mbs=1 \
    task1.rew_inf.n_mbs=1 \
    task1.cgpo.kl_ctl=0.05 \
    task1.cgpo.reward_output_scaling=1.5 \
    task1.cgpo.reward_output_bias=-2.0 \
    task1.cgpo.gae_lambda=1.0 task1.cgpo.no_eos_penalty=-10. \
    task1.cgpo.adv_norm=True task1.cgpo.value_norm=True 